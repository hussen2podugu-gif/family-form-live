<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>VAMSA VRUKSHAM</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 10px;
  padding: 0;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
}
h2 {
  text-align: center;
  margin-bottom: 10px;
  font-size: 20px;
}
.grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
}
.field {
  display: flex;
  align-items: center;
  gap: 10px;
}
.field label {
  font-weight: bold;
  font-size: 16px;
  white-space: nowrap;
  width: 120px;
}
.field input {
  flex: 1;
  padding: 10px;
  font-size: 16px;
}
.required::after {
  content: " *";
  color: red;
}
.message {
  font-weight: bold;
  color: blue;
  margin-bottom: 12px;
}
.actions {
  text-align: center;
  margin-top: 10px;
}
button {
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  background: #007bff;
  color: #fff;
  cursor: pointer;
  width: 100%;
}
button.skip {
  background: #ff9800;
}
.search-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 20px;
}
.search-row label {
  font-weight: bold;
  font-size: 16px;
  white-space: nowrap;
}
.search-row input {
  flex: 1;
  padding: 10px;
  font-size: 16px;
}
table {
  width: 100%;
  margin-top: 10px;
  border-collapse: collapse;
}
table th, table td {
  padding: 8px;
  border: 1px solid #ccc;
  text-align: left;
}
table th {
  background: #f0f0f0;
  cursor: pointer;
}
</style>
</head>
<body>
<h2 id="formTitle">VAMSA VRUKSHAM</h2>

<div id="lblMsg" class="message"></div>

<form id="familyForm">
<div class="grid">
  <div class="field">
    <label for="mid">1. MId:</label>
    <input type="text" id="mid" name="mid" readonly>
  </div>

  <div class="field">
    <label for="surname" class="required">2. Surname:</label>
    <input type="text" id="surname" name="surname" required>
  </div>

  <div class="field">
    <label for="name" class="required">3. Name:</label>
    <input list="namesList" id="name" name="name" required>
    <datalist id="namesList"></datalist>
  </div>

  <div class="actions"><button type="submit" id="btnSave">Save</button></div>
</div>
</form>

<div class="search-row">
  <label for="searchBox">Search:</label>
  <input type="text" id="searchBox" placeholder="Search by name or surname...">
</div>

<table id="recordsTable">
  <thead>
    <tr>
      <th onclick="sortTable(0)">Mid ⬍</th>
      <th onclick="sortTable(1)">Surname ⬍</th>
      <th onclick="sortTable(2)">Name ⬍</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", function(){
const scriptURL = "https://script.google.com/macros/s/AKfycbwZZrIPcM0X3T41D6pMfsMhzMSGewY6AB3Cj8QS-4EUdaDmzsIoSmx_JlOKKEui1JHGFg/exec";
const lblMsg = document.getElementById("lblMsg"),
      midField = document.getElementById("mid"),
      surnameField = document.getElementById("surname"),
      nameField = document.getElementById("name"),
      namesList = document.getElementById("namesList"),
      form = document.getElementById("familyForm"),
      btnSave = document.getElementById("btnSave");

const memberConsent = "I would like to be a member of our family tree. I am giving the required information: 1. Surname, 2. Full Name, 3. Date of Birth / Age, 4. Mother's Name, 5. Spouse Name if married, 6. Place of Birth, 7. No. of Children and other optionals if I desired. I am also giving the details of my relatives as far as I know. I will inform them about this and ask them to correct it.";
const nameMsg = "If any nick name put in brackets () at end.";
const duplicateMsg = "is already registered. So add your nick name or your mother's membership Id in brackets () at end.";

function showMsg(text, color) {
  lblMsg.style.color = color || "black";
  lblMsg.textContent = text;
}

function initForm() {
  showMsg(memberConsent, "blue");

  fetch(scriptURL + "?action=getNextId")
    .then(r => r.json())
    .then(js => {
      if (js.status === "ok") {
        midField.value = js.nextId || "";
        if (js.lastSurname) surnameField.value = js.lastSurname;
      } else showMsg(js.message, "red");
      loadRecords();
    })
    .catch(() => {
      showMsg(memberConsent + " (Note: Could not connect to server for MId)", "blue");
      loadRecords();
    });
}

initForm();

fetch(scriptURL + "?action=getNames")
  .then(r => r.json())
  .then(list => {
    namesList.innerHTML = "";
    if (Array.isArray(list)) {
      list.forEach(n => {
        namesList.appendChild(Object.assign(document.createElement("option"), { value: n }));
      });
    }
  })
  .catch(() => console.log("Could not load names list"));

form.addEventListener("submit", ev => {
  ev.preventDefault();

  const surname = surnameField.value.trim(),
        name = nameField.value.trim();

  if (!surname || !name) {
    showMsg("Surname and Name are mandatory.", "red");
    return;
  }

  if (btnSave.textContent === "Skip") {
    performSave(true);
    restoreSave();
    return;
  }

  fetch(scriptURL + "?action=checkDuplicate&surname=" + encodeURIComponent(surname) + "&name=" + encodeURIComponent(name))
    .then(r => r.json())
    .then(dup => {
      if (dup) {
        const fullName = `${surname} ${name}`;
        showMsg(`${fullName} ${duplicateMsg}`, "blue");
        btnSave.textContent = "Skip";
        btnSave.classList.add("skip");
      } else {
        showMsg("", "black");
        performSave(false);
      }
    })
    .catch(() => showMsg("Error connecting to server (duplicate check).", "red"));
});

function restoreSave() {
  btnSave.textContent = "Save";
  btnSave.classList.remove("skip");
}

function performSave(skip) {
  const fd = new FormData(form);
  if (skip) fd.append("skip", "1");

  fetch(scriptURL, { method: "POST", body: fd })
    .then(r => r.json())
    .then(js => {
      if (js.status === "success") {
        showMsg(js.message + " " + nameMsg, "green");
        form.reset();
        restoreSave();
        initForm();
      } else if (js.status === "error") {
        showMsg(js.message || "Save failed", "red");
      } else showMsg("Unexpected response", "red");
    })
    .catch(() => showMsg("Error connecting to server (POST)", "red"));
}

function loadRecords() {
  fetch(scriptURL + "?action=getAll")
    .then(r => r.json())
    .then(data => {
      const tbody = document.querySelector("#recordsTable tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.mid}</td>
          <td>${row.surname}</td>
          <td>${row.name}</td>
          <td>
            <span style="cursor:pointer;color:blue;"
